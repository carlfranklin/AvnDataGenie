@inject AppState appState
@implements IDisposable

<div class="sidebar-header">
    <div class="brand">
        <span class="brand-icon">✨</span>
        <div class="brand-text">
            <span class="brand-name">AvnDataGenie</span>
            <span class="brand-subtitle">Configuration</span>
        </div>
    </div>
</div>

<input type="checkbox" title="Navigation menu" class="navbar-toggler" />

<div class="nav-scrollable" onclick="document.querySelector('.navbar-toggler').click()">
    <nav class="nav flex-column">
        <!-- Setup Progress as Navigation -->
        <div class="progress-section">
            <div class="progress-header">
                <span class="progress-title">Setup Progress</span>
                <span class="progress-count">@GetCompletedSteps()/4</span>
            </div>
            <div class="progress-steps">
                <NavLink class="@GetStepClasses(1)" href="" Match="NavLinkMatch.All">
                    <div class="step-indicator">
                        @if (IsStepComplete(1))
                        {
                            <span class="step-check">✓</span>
                        }
                        else
                        {
                            <span class="step-number">1</span>
                        }
                    </div>
                    <div class="step-content">
                        <span class="step-title">Connect</span>
                        <span class="step-desc">Add connection string</span>
                    </div>
                </NavLink>
                <NavLink class="@GetStepClasses(2)" href="" Match="NavLinkMatch.All">
                    <div class="step-indicator">
                        @if (IsStepComplete(2))
                        {
                            <span class="step-check">✓</span>
                        }
                        else
                        {
                            <span class="step-number">2</span>
                        }
                    </div>
                    <div class="step-content">
                        <span class="step-title">Generate</span>
                        <span class="step-desc">Extract database schema</span>
                    </div>
                </NavLink>
                <NavLink class="@GetStepClasses(3)" href="config">
                    <div class="step-indicator">
                        @if (IsStepComplete(3))
                        {
                            <span class="step-check">✓</span>
                        }
                        else
                        {
                            <span class="step-number">3</span>
                        }
                    </div>
                    <div class="step-content">
                        <span class="step-title">Configure</span>
                        <span class="step-desc">Add metadata & rules</span>
                    </div>
                </NavLink>
                <NavLink class="@GetStepClasses(4)" href="TestRuntime">
                    <div class="step-indicator">
                        @if (IsStepComplete(4))
                        {
                            <span class="step-check">✓</span>
                        }
                        else
                        {
                            <span class="step-number">4</span>
                        }
                    </div>
                    <div class="step-content">
                        <span class="step-title">Test</span>
                        <span class="step-desc">Verify your setup</span>
                    </div>
                </NavLink>
            </div>
        </div>

        <!-- Configuration Files Status -->
        <div class="files-section">
            <div class="section-header">
                <span class="section-icon">📁</span>
                <span class="section-title">Configuration Files</span>
            </div>
            
            <!-- Schema File Card -->
            <div class="file-card @(appState.SchemaFileExists ? "file-ready" : "file-pending")">
                <div class="file-card-header">
                    <span class="file-icon">🗄️</span>
                    <span class="file-label">Database Schema</span>
                    <span class="file-status-badge @(appState.SchemaFileExists ? "badge-ready" : "badge-pending")">
                        @(appState.SchemaFileExists ? "Ready" : "Missing")
                    </span>
                </div>
                @if (appState.SchemaFileExists)
                {
                    <div class="file-card-details">
                        <div class="file-detail">
                            <span class="detail-label">File:</span>
                            <span class="detail-value file-name" title="@appState.SaveFilePath">@appState.SchemaFileName</span>
                        </div>
                        @if (appState.SchemaFileLastModified.HasValue)
                        {
                            <div class="file-detail">
                                <span class="detail-label">Modified:</span>
                                <span class="detail-value">@appState.SchemaFileLastModified.Value.ToString("MMM dd, HH:mm")</span>
                            </div>
                        }
                        @if (appState.DatabaseSchema != null)
                        {
                            <div class="file-detail">
                                <span class="detail-label">Contains:</span>
                                <span class="detail-value">@appState.DatabaseSchema.Tables.Count tables</span>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="file-card-empty">
                        <span class="empty-text">Generate schema from database to get started</span>
                    </div>
                }
            </div>

            <!-- LLM Config File Card -->
            <div class="file-card @(appState.ConfigFileExists ? "file-ready" : "file-pending")">
                <div class="file-card-header">
                    <span class="file-icon">⚙️</span>
                    <span class="file-label">LLM Configuration</span>
                    <span class="file-status-badge @(appState.ConfigFileExists ? "badge-ready" : "badge-pending")">
                        @(appState.ConfigFileExists ? "Ready" : "Missing")
                    </span>
                </div>
                @if (appState.ConfigFileExists)
                {
                    <div class="file-card-details">
                        <div class="file-detail">
                            <span class="detail-label">File:</span>
                            <span class="detail-value file-name" title="@appState.ConfigSaveFilePath">@appState.ConfigFileName</span>
                        </div>
                        @if (appState.ConfigFileLastModified.HasValue)
                        {
                            <div class="file-detail">
                                <span class="detail-label">Modified:</span>
                                <span class="detail-value">@appState.ConfigFileLastModified.Value.ToString("MMM dd, HH:mm")</span>
                            </div>
                        }
                        @if (appState.HasConfiguration)
                        {
                            <div class="file-detail">
                                <span class="detail-label">Saved:</span>
                                <span class="detail-value saved-indicator @(appState.ConfigurationSaved ? "saved" : "unsaved")">
                                    @(appState.ConfigurationSaved ? "✓ Yes" : "⚠ Unsaved changes")
                                </span>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="file-card-empty">
                        <span class="empty-text">Configure and save LLM settings</span>
                    </div>
                }
            </div>
        </div>

        @if (appState.HasSchema && appState.DatabaseSchema != null)
        {
            <!-- Schema Stats -->
            <div class="stats-section">
                <div class="stats-header">
                    <span class="stats-icon">📊</span>
                    <span class="stats-title">Schema Summary</span>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-value">@appState.DatabaseSchema.Tables.Count</span>
                        <span class="stat-label">Tables</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">@appState.DatabaseSchema.Tables.Sum(t => t.Columns.Count)</span>
                        <span class="stat-label">Columns</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">@appState.DatabaseSchema.Tables.Sum(t => t.ForeignKeys.Count)</span>
                        <span class="stat-label">Relations</span>
                    </div>
                </div>
            </div>
        }

        @if (appState.HasConfiguration)
        {
            <!-- Config Stats -->
            <div class="stats-section">
                <div class="stats-header">
                    <span class="stats-icon">🔧</span>
                    <span class="stats-title">LLM Config Summary</span>
                </div>
                <div class="config-stats">
                    <div class="config-stat-row">
                        <span class="config-stat-label">Table Configs</span>
                        <span class="config-stat-value">@appState.ConfiguredTablesCount</span>
                    </div>
                    <div class="config-stat-row">
                        <span class="config-stat-label">Join Hints</span>
                        <span class="config-stat-value">@appState.JoinHintsCount</span>
                    </div>
                    <div class="config-stat-row">
                        <span class="config-stat-label">Required Filters</span>
                        <span class="config-stat-value">@appState.RequiredFiltersCount</span>
                    </div>
                    <div class="config-stat-row">
                        <span class="config-stat-label">Business Terms</span>
                        <span class="config-stat-value">@appState.BusinessTermsCount</span>
                    </div>
                </div>
            </div>
        }

        @if (appState.TestCompleted)
        {
            <!-- Test Status -->
            <div class="stats-section test-section">
                <div class="stats-header">
                    <span class="stats-icon">✅</span>
                    <span class="stats-title">Last Test Run</span>
                </div>
                <div class="test-info">
                    @if (appState.LastTestRun.HasValue)
                    {
                        <div class="test-detail">
                            <span class="test-label">Ran:</span>
                            <span class="test-value">@appState.LastTestRun.Value.ToString("MMM dd, HH:mm")</span>
                        </div>
                    }
                    @if (appState.LastTestQueryCount.HasValue)
                    {
                        <div class="test-detail">
                            <span class="test-label">Queries:</span>
                            <span class="test-value">@appState.LastTestQueryCount.Value tested</span>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Restart Button -->
        <div class="restart-section">
            <button class="restart-button" @onclick="ShowRestartConfirmation" title="Clear all configuration and start over">
                <span class="restart-icon">🔄</span>
                <span class="restart-text">Restart Setup</span>
            </button>
        </div>

        @if (showRestartConfirmation)
        {
            <div class="restart-confirmation">
                <p class="confirm-text">Clear all configuration?</p>
                <div class="confirm-options">
                    <label class="confirm-checkbox">
                        <input type="checkbox" @bind="deleteFiles" />
                        <span>Also delete files</span>
                    </label>
                </div>
                <div class="confirm-buttons">
                    <button class="btn-confirm-yes" @onclick="RestartProcess">Yes, restart</button>
                    <button class="btn-confirm-no" @onclick="CancelRestart">Cancel</button>
                </div>
            </div>
        }
    </nav>
</div>

@code {
    private bool showRestartConfirmation = false;
    private bool deleteFiles = false;

    protected override void OnInitialized()
    {
        appState.OnChange += StateHasChanged;
        appState.RefreshFileStatus();
    }

    public void Dispose()
    {
        appState.OnChange -= StateHasChanged;
    }

    private int GetCompletedSteps()
    {
        int count = 0;
        if (appState.HasSchema) count = 2; // Connect + Generate done
        if (appState.HasConfiguration && appState.ConfigurationSaved) count = 3;
        if (appState.TestCompleted) count = 4;
        return count;
    }

    private bool IsStepComplete(int step)
    {
        return step switch
        {
            1 => appState.HasSchema, // If we have schema, connection was made
            2 => appState.HasSchema,
            3 => appState.HasConfiguration && appState.ConfigurationSaved,
            4 => appState.TestCompleted,
            _ => false
        };
    }

    private string GetStepClasses(int step)
    {
        var classes = "progress-step";
        
        if (IsStepComplete(step))
        {
            classes += " complete";
        }
        else
        {
            // Determine if this is the current/active step
            var currentStep = (int)appState.CurrentStep;
            if (step == currentStep || step == currentStep + 1)
            {
                classes += " current";
            }
        }
        
        // Allow access to Test step if we have schema and configuration loaded (even if not saved)
        if (step == 4 && appState.HasSchema && appState.HasConfiguration)
        {
            classes += " current";
        }
        
        return classes;
    }

    private void ShowRestartConfirmation()
    {
        showRestartConfirmation = true;
        deleteFiles = false;
    }

    private void CancelRestart()
    {
        showRestartConfirmation = false;
        deleteFiles = false;
    }

    private void RestartProcess()
    {
        // Delete files if requested
        if (deleteFiles)
        {
            try
            {
                if (File.Exists(appState.SaveFilePath))
                    File.Delete(appState.SaveFilePath);
                if (File.Exists(appState.ConfigSaveFilePath))
                    File.Delete(appState.ConfigSaveFilePath);
            }
            catch
            {
                // Silently ignore file deletion errors
            }
        }

        // Clear all state
        appState.SchemaJson = string.Empty;
        appState.DatabaseSchema = null;
        appState.LlmConfiguration = new QueryGenerator.Models.LlmConfiguration();
        appState.ConfigurationSaved = false;
        appState.SchemaFileLastModified = null;
        appState.ConfigFileLastModified = null;
        appState.TestCompleted = false;
        appState.LastTestRun = null;
        appState.LastTestQueryCount = null;
        
        appState.RefreshFileStatus();
        appState.NotifyStateChanged();

        showRestartConfirmation = false;
        deleteFiles = false;
    }
}

