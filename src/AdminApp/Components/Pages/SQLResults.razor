@* 
    ========================================
    Component: SQLResults
    ========================================
    Purpose: Executes LLM-generated SQL queries and displays results in a table format.
    
    Key Features:
    - Automatic query execution on page load
    - Configurable connection string (stored in AppState)
    - Real-time result display with scrollable table
    - Error handling with user-friendly messages
    - Column name formatting for readability
    
    Dependencies:
    - AppState (injected) - Stores SQL query and connection string
    - NavigationManager (injected) - Page navigation
    - Microsoft.Data.SqlClient - Database connectivity
    
    Route: /sqlresults
    ========================================
*@
@page "/sqlresults"
@using Microsoft.Data.SqlClient
@using System.Data
@inject AppState appState
@inject NavigationManager navigationManager

@rendermode InteractiveServer

<PageTitle>SQL Results - AvnDataGenie</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h3 class="mb-4">SQL Query Results</h3>
        </div>
    </div>

    @* Show warning if no SQL query is available in AppState *@
    @if (!HasSqlString)
    {
        <div class="alert alert-warning" role="alert">
            <i class="bi bi-exclamation-triangle"></i> No SQL query available. Please generate a query first.
        </div>
        <button class="btn btn-primary" @onclick="@(() => navigationManager.NavigateTo("/testruntime"))">
            <i class="bi bi-arrow-left"></i> Go to Test Runtime
        </button>
    }
    else
    {
        @* Display the SQL query that will be/was executed *@
        <div class="row mb-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-code-square"></i> SQL Query
                        </h5>
                    </div>
                    <div class="card-body">
                        <pre class="mb-0" style="background-color: #f8f9fa; padding: 1rem; border-radius: 0.25rem;"><code>@appState.SQLString</code></pre>
                    </div>
                </div>
            </div>
        </div>

        @* Connection string input and execute button *@
        <div class="row mb-3">
            <div class="col-md-8">
                <label for="connectionString" class="form-label">Connection String:</label>
                <input type="text" id="connectionString" class="form-control" @bind="connectionString" />
            </div>
            <div class="col-md-4 d-flex align-items-end">
                @* Execute button with loading state indicator *@
                <button class="btn btn-primary w-100" @onclick="ExecuteQuery" disabled="@isExecuting">
                    @if (isExecuting)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        <text>Executing...</text>
                    }
                    else
                    {
                        <i class="bi bi-play-fill me-2"></i>
                        <text>Execute Query</text>
                    }
                </button>
            </div>
        </div>

        @* Display error message if query execution failed *@
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger" role="alert">
                <strong>Error:</strong> @errorMessage
            </div>
        }

        @* Display query results in a scrollable table *@
        @if (resultData != null && resultData.Rows.Count > 0)
        {
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-table"></i> Results (@resultData.Rows.Count rows)
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            @* Scrollable table container (max 600px height) *@
                            <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                                <table class="table table-striped table-hover mb-0">
                                    <thead>
                                        <tr>
                                            @* Render column headers with formatted names *@
                                            @foreach (DataColumn column in resultData.Columns)
                                            {
                                                <th>@FormatColumnName(column.ColumnName)</th>
                                            }
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @* Render data rows *@
                                        @foreach (DataRow row in resultData.Rows)
                                        {
                                            <tr>
                                                @foreach (DataColumn column in resultData.Columns)
                                                {
                                                    <td>@row[column]</td>
                                                }
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
        else if (executionComplete && (resultData == null || resultData.Rows.Count == 0))
        {
            @* Show info message when query returns no rows *@
            <div class="alert alert-info" role="alert">
                <i class="bi bi-info-circle"></i> Query executed successfully but returned no results.
            </div>
        }
    }
</div>

@code {
    // Connection string for SQL Server (editable by user)
    private string connectionString = string.Empty;
    
    // DataTable holding query results
    private DataTable? resultData;
    
    // Error message to display if query execution fails
    private string errorMessage = string.Empty;
    
    // Loading state indicator
    private bool isExecuting = false;
    
    // Flag indicating query has completed (success or failure)
    private bool executionComplete = false;

    // Computed property to check if SQL query exists in AppState
    private bool HasSqlString => !string.IsNullOrWhiteSpace(appState.SQLString);

    /// <summary>
    /// Initialize component on page load.
    /// Loads connection string from AppState and auto-executes the query.
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        // Use connection string from AppState if available (set on Home page)
        if (!string.IsNullOrEmpty(appState.ConnectionString))
        {
            connectionString = appState.ConnectionString;
        }
        else
        {
            // Default fallback connection string for Chinook database
            connectionString = "Data Source=(localdb)\\MSSQLLocalDB;Initial Catalog=Chinook;Integrated Security=True;Connect Timeout=30;Encrypt=True;Trust Server Certificate=False;Application Intent=ReadWrite;Multi Subnet Failover=False;Command Timeout=30";
        }
        
        // If no SQL query is available, show warning message instead of executing
        if (!HasSqlString)
        {
            return;
        }
        
        // Auto-execute the query on page load for immediate results
        await ExecuteQuery();
    }

    /// <summary>
    /// Executes the SQL query stored in AppState against the configured database.
    /// Loads results into a DataTable for display in the UI.
    /// </summary>
    private async Task ExecuteQuery()
    {
        // Validate connection string
        if (string.IsNullOrWhiteSpace(connectionString))
        {
            errorMessage = "Please enter a connection string.";
            return;
        }

        // Validate SQL query exists
        if (string.IsNullOrWhiteSpace(appState.SQLString))
        {
            errorMessage = "No SQL query to execute.";
            return;
        }

        // Set loading state and clear previous results
        isExecuting = true;
        executionComplete = false;
        errorMessage = string.Empty;
        resultData = null;
        StateHasChanged();

        try
        {
            // Open database connection
            using var connection = new SqlConnection(connectionString);
            await connection.OpenAsync();

            // Create command with the LLM-generated SQL
            using var command = new SqlCommand(appState.SQLString, connection);
            command.CommandType = CommandType.Text;
            command.CommandTimeout = 30;  // 30 second timeout

            // Execute query and read results
            using var reader = await command.ExecuteReaderAsync();
            
            // Load results into DataTable for easy display
            resultData = new DataTable();
            resultData.Load(reader);

            executionComplete = true;
        }
        catch (Exception ex)
        {
            // Capture and display any SQL or connection errors
            errorMessage = ex.Message;
            executionComplete = false;
        }
        finally
        {
            // Clear loading state and refresh UI
            isExecuting = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// Formats column names for better readability in the UI.
    /// Converts "CustomerID" to "Customer ID", "FirstName" to "First Name", etc.
    /// </summary>
    /// <param name="columnName">Raw column name from database</param>
    /// <returns>Formatted column name with spaces before capital letters</returns>
    private string FormatColumnName(string columnName)
    {
        if (string.IsNullOrWhiteSpace(columnName))
            return columnName;

        // Insert space before capital letters (except the first one)
        // Example: "CustomerID" â†’ "Customer ID"
        var result = System.Text.RegularExpressions.Regex.Replace(
            columnName, 
            "(?<!^)([A-Z])",  // Match capitals not at the start
            " $1"  // Add space before the capital
        );

        return result;
    }
}
