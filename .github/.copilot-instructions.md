# AvnDataGenie - Copilot Instructions

## Project Overview
AvnDataGenie is an open-source system that enables users to query databases using natural language. It addresses security, performance, and flexibility issues found in existing SQL MCP Servers by providing better control and constraints.

## Core Concepts

### Key Features
- **Metadata Management**: Pre-generate and manage database metadata with annotations, aliases, and constraints
- **Security First**: Controlled access with field-level restrictions (e.g., hide PII like SSN)
- **Local AI Models**: Optional Ollama integration for SQL generation without data sharing
- **Performance Optimized**: Metadata loaded beforehand, avoiding per-request metadata gathering

### Architecture Goals
- Generate metadata beforehand with management tools
- Support table/column descriptions and aliases
- Implement record return constraints
- Field-level security (hide sensitive data)
- Local model execution via Ollama (optional)
- Performant metadata loading

## Technology Stack

### Core Technologies
- **.NET 10**: Primary framework (SDK version 10.0.101)
- **Aspire**: Cloud-native orchestration and development
- **Ollama**: Local AI model hosting for SQL generation
- **Gemma**: Default AI model (gemma3:1b)

### Current Structure
```
src/
├── .aspire/           # Aspire configuration
├── apphost.cs         # Aspire application host
├── apphost.run.json   # Runtime configuration
└── global.json       # .NET SDK version pinning
```

## Development Guidelines

### Code Style & Standards
- Follow standard .NET conventions and naming
- Use minimal APIs where appropriate
- Implement proper async/await patterns
- Include comprehensive error handling
- Add XML documentation for public APIs

### Security Considerations
- Never expose raw database access
- Implement field-level security controls
- Validate all SQL queries before execution
- Sanitize user inputs
- Audit trail for all database operations

### Performance Guidelines
- Cache metadata in memory after initial load
- Use connection pooling for database access
- Implement query result caching where appropriate
- Monitor and limit query execution time
- Implement proper pagination for large result sets

## Aspire Integration

### Current Configuration
- Ollama service configured as "ollama"
- Gemma 1B model configured as default
- Uses CommunityToolkit.Aspire.Hosting.Ollama package

### Expected Extensions
- Database connections (SQL Server, PostgreSQL, etc.)
- Web API services for query interface
- Metadata management services
- Authentication/authorization services

## Database Integration Patterns

### Metadata Management
```csharp
// Expected patterns for metadata handling
public class TableMetadata
{
    public string Name { get; set; }
    public string Description { get; set; }
    public string Alias { get; set; }
    public int MaxRecords { get; set; }
    public List<ColumnMetadata> Columns { get; set; }
}

public class ColumnMetadata
{
    public string Name { get; set; }
    public string Description { get; set; }
    public string Alias { get; set; }
    public bool IsHidden { get; set; }  // For PII protection
    public string DataType { get; set; }
}
```

### Query Generation Pipeline
1. Parse natural language input
2. Load relevant metadata
3. Generate SQL query using local AI model
4. Validate query against constraints
5. Execute with security checks
6. Format and return results

## AI Integration Guidelines

### Ollama Usage
- Use local models to avoid data exposure
- Implement fallback mechanisms for model failures
- Cache frequently used query patterns
- Monitor model performance and accuracy

### Query Generation Best Practices
- Include metadata context in prompts
- Validate generated SQL syntax
- Apply security constraints before execution
- Log all generated queries for analysis

## Testing Strategy

### Unit Tests
- Test metadata loading and caching
- Test query generation accuracy
- Test security constraint enforcement
- Test SQL validation logic

### Integration Tests
- Test complete query pipeline
- Test database connection handling
- Test Ollama integration
- Test error handling scenarios

### Performance Tests
- Load testing for concurrent users
- Query performance benchmarking
- Memory usage monitoring
- Model inference timing

## Future Considerations

### Planned Features
- Web-based metadata management UI
- Multiple database provider support
- Advanced query optimization
- Role-based access controls
- Query result visualization
- API rate limiting

### Extensibility Points
- Plugin system for custom data sources
- Custom AI model integration
- Extensible metadata schema
- Custom security providers

## Common Development Tasks

When working on this project:

1. **Adding new database providers**: Extend metadata loading, implement provider-specific SQL generation
2. **Enhancing AI integration**: Update prompt engineering, add model configuration options
3. **Improving security**: Add new constraint types, enhance field-level controls
4. **Performance optimization**: Profile query execution, optimize metadata caching
5. **UI development**: Build metadata management interfaces, query result displays

## Dependencies & Packages

- `CommunityToolkit.Aspire.Hosting.Ollama` - Ollama integration
- `Aspire.AppHost.Sdk` - Aspire hosting SDK
- Additional packages will be added for database connectivity, web APIs, etc.

---

Remember: This project prioritizes security and performance while maintaining flexibility. Always consider the impact of changes on these core principles.